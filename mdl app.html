<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3a8a">
    <title>Gestion MDL - Henri Brisson</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%231e3a8a'/><text x='50' y='60' font-size='35' text-anchor='middle' fill='white' font-weight='bold'>HB</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        
        html {
            overflow-x: hidden;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #3b82f6 100%);
            padding: 1.5rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #1e3a8a;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .logo-text {
            font-size: 18px;
            line-height: 1;
        }
        
        .logo-year {
            font-size: 8px;
            opacity: 0.7;
        }
        
        .header-title h1 {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .header-title p {
            color: rgba(255,255,255,0.8);
            font-size: 0.8rem;
        }
        
        .header-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-family: 'Outfit', sans-serif;
        }
        
        .export-btn:active {
            transform: scale(0.95);
        }
        
        /* Navigation */
        nav {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-btn {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
            white-space: nowrap;
        }
        
        .nav-btn.active {
            color: #1e3a8a;
            border-bottom-color: #3b82f6;
            background: #f1f5f9;
        }
        
        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.4s ease-in;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Caisse Grid */
        .caisse-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .caisse-grid {
                grid-template-columns: 1fr 400px;
            }
        }
        
        /* Search */
        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        
        .product-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            touch-action: manipulation;
        }
        
        .product-card:active {
            transform: scale(0.95);
            border-color: #3b82f6;
        }
        
        .product-card.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }
        
        .product-card.out-of-stock::after {
            content: 'Rupture';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .product-card.low-stock {
            border-color: #f59e0b;
            background: #fef3c7;
        }
        
        .product-image {
            width: 100%;
            height: 100px;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            overflow: hidden;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .product-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #0f172a;
            margin-bottom: 0.25rem;
        }
        
        .product-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }
        
        .product-stock {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Cart */
        .cart-items {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #0f172a;
        }
        
        .cart-item-price {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        .cart-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .cart-btn {
            min-width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: white;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .cart-btn:active {
            transform: scale(0.9);
        }
        
        .cart-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .cart-quantity {
            font-weight: 700;
            min-width: 30px;
            text-align: center;
        }
        
        .cart-total {
            padding: 1rem 0;
            border-top: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .cart-total-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0f172a;
        }
        
        .cart-total-amount {
            font-size: 1.75rem;
            font-weight: 800;
            color: #3b82f6;
        }
        
        .validate-btn {
            width: 100%;
            padding: 1.25rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
            touch-action: manipulation;
        }
        
        .validate-btn:active {
            transform: scale(0.98);
        }
        
        .validate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--color-from), var(--color-to));
            padding: 1.5rem;
            border-radius: 16px;
            color: white;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        thead {
            background: #f8fafc;
        }
        
        th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 700;
            color: #475569;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        
        td {
            padding: 1rem 0.75rem;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .btn-save {
            background: #d1fae5;
            color: #065f46;
        }
        
        /* Input */
        input, select {
            padding: 0.5rem 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #94a3b8;
        }
        
        .empty-emoji {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        /* Alert */
        .alert-box {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-text">HB</div>
                    <div class="logo-year">1887</div>
                </div>
                <div class="header-title">
                    <h1>Gestion MDL</h1>
                    <p>Lyc√©e Henri Brisson ‚Ä¢ Vierzon</p>
                </div>
            </div>
            <div class="header-buttons">
                <button class="export-btn" onclick="exportData()">üíæ</button>
                <button class="export-btn" onclick="importData()">üìÇ</button>
                <button class="export-btn" onclick="toggleFullscreen()">‚õ∂</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <button class="nav-btn active" onclick="switchTab(event, 'caisse')">üõí Caisse</button>
            <button class="nav-btn" onclick="switchTab(event, 'stock')">üì¶ Stock</button>
            <button class="nav-btn" onclick="switchTab(event, 'stats')">üìä Stats</button>
            <button class="nav-btn" onclick="switchTab(event, 'courses')">üõçÔ∏è Courses</button>
        </div>
    </nav>

    <!-- Content -->
    <div class="container">
        <!-- CAISSE -->
        <div id="tab-caisse" class="content-section active">
            <div class="caisse-grid">
                <div>
                    <div class="card">
                        <div class="card-body" style="padding: 1rem;">
                            <input type="text" class="search-input" placeholder="üîç Rechercher un produit..." 
                                id="searchProduct" oninput="renderProducts()">
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Produits</h2>
                        </div>
                        <div class="card-body">
                            <div class="products-grid" id="productsList"></div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Panier</h2>
                        </div>
                        <div class="card-body">
                            <div class="cart-items" id="cartItems"></div>
                            <div class="cart-total">
                                <span class="cart-total-label">Total</span>
                                <span class="cart-total-amount" id="cartTotal">0.00 ‚Ç¨</span>
                            </div>
                            <button class="validate-btn" onclick="validateSale()">‚úì Valider la vente</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STOCK -->
        <div id="tab-stock" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Stock</h2>
                    <button class="btn btn-primary" onclick="addProduct()">+ Ajouter</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>Produit</th>
                                <th>Cat√©gorie</th>
                                <th>Prix</th>
                                <th>Stock</th>
                                <th>Min</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stockTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- STATS -->
        <div id="tab-stats" class="content-section">
            <div style="margin-bottom: 1rem;">
                <select class="search-input" style="max-width: 300px;" id="statsPeriod" onchange="renderStats()">
                    <option value="all">Toutes les p√©riodes</option>
                    <option value="today">Aujourd'hui</option>
                    <option value="week">Cette semaine</option>
                    <option value="month">Ce mois</option>
                    <option value="year">Cette ann√©e</option>
                </select>
            </div>
            
            <!-- KPIs principaux -->
            <div class="stats-grid">
                <div class="stat-card" style="--color-from: #10b981; --color-to: #059669;">
                    <div class="stat-label">üí∞ Chiffre d'affaires</div>
                    <div class="stat-value" id="statRevenue">0 ‚Ç¨</div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;" id="statRevenueEvolution"></div>
                </div>
                <div class="stat-card" style="--color-from: #3b82f6; --color-to: #1e40af;">
                    <div class="stat-label">üõí Nombre de ventes</div>
                    <div class="stat-value" id="statSales">0</div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;" id="statSalesEvolution"></div>
                </div>
                <div class="stat-card" style="--color-from: #8b5cf6; --color-to: #6d28d9;">
                    <div class="stat-label">üìä Panier moyen</div>
                    <div class="stat-value" id="statAvg">0 ‚Ç¨</div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;" id="statAvgEvolution"></div>
                </div>
                <div class="stat-card" style="--color-from: #f59e0b; --color-to: #d97706;">
                    <div class="stat-label">üì¶ Articles vendus</div>
                    <div class="stat-value" id="statTotalItems">0</div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">articles au total</div>
                </div>
            </div>

            <!-- Graphiques et analyses -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1rem;">
                <!-- Graphique √©volution CA -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìà √âvolution du CA</h3>
                        <select id="chartPeriod" onchange="renderStats()" style="padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'Outfit', sans-serif;">
                            <option value="7">7 derniers jours</option>
                            <option value="14" selected>14 derniers jours</option>
                            <option value="30">30 derniers jours</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Analyses par cat√©gorie et horaires -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè∑Ô∏è Ventes par cat√©gorie</h3>
                    </div>
                    <div class="card-body" id="categoryStats"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚è∞ Ventes par heure</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="hourlyChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìÖ Ventes par jour de la semaine</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="weekdayChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Analyses financi√®res pour tr√©sorier -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üíº Rapport tr√©sorerie</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="padding: 1rem; background: #f0fdf4; border-radius: 12px; border-left: 4px solid #10b981;">
                                <div style="font-size: 0.85rem; color: #065f46; margin-bottom: 0.25rem;">CA journalier moyen</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;" id="avgDailyRevenue">0 ‚Ç¨</div>
                            </div>
                            <div style="padding: 1rem; background: #eff6ff; border-radius: 12px; border-left: 4px solid #3b82f6;">
                                <div style="font-size: 0.85rem; color: #1e40af; margin-bottom: 0.25rem;">Meilleure journ√©e</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;" id="bestDay">0 ‚Ç¨</div>
                            </div>
                            <div style="padding: 1rem; background: #fef3c7; border-radius: 12px; border-left: 4px solid #f59e0b;">
                                <div style="font-size: 0.85rem; color: #92400e; margin-bottom: 0.25rem;">Valeur stock</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;" id="stockValue">0 ‚Ç¨</div>
                            </div>
                            <div style="padding: 1rem; background: #fae8ff; border-radius: 12px; border-left: 4px solid #a855f7;">
                                <div style="font-size: 0.85rem; color: #6b21a8; margin-bottom: 0.25rem;">Produit le + rentable</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: #a855f7;" id="topProduct">-</div>
                            </div>
                        </div>
                        
                        <div style="padding: 1rem; background: #f8fafc; border-radius: 12px;">
                            <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: #0f172a;">üìä Pr√©visions</h4>
                            <div style="display: grid; gap: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #64748b;">CA pr√©visionnel semaine prochaine</span>
                                    <span style="font-weight: 700; color: #3b82f6;" id="forecastWeek">0 ‚Ç¨</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #64748b;">CA pr√©visionnel mois prochain</span>
                                    <span style="font-weight: 700; color: #3b82f6;" id="forecastMonth">0 ‚Ç¨</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top produits et ventes r√©centes -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üèÜ Classement produits</h3>
                    </div>
                    <div class="card-body" id="topProducts"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üïí Historique des ventes</h3>
                    </div>
                    <div class="card-body" id="recentSales" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- COURSES -->
        <div id="tab-courses" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Liste des courses</h2>
                </div>
                <div class="card-body" id="shoppingList"></div>
            </div>
        </div>
    </div>

    <script>
        let products = [
            { id: 1, name: "Chocolat Chaud", price: 0.40, stock: 50, minStock: 10, category: "Boisson", image: "image/benco.jpg" },
            { id: 2, name: "Caf√©", price: 1.00, stock: 50, minStock: 10, category: "Boisson", image: "image/caf√©.jpg" },
            { id: 3, name: "Caf√© au lait", price: 1.00, stock: 30, minStock: 15, category: "Boisson", image: "image/caf√©aulait.jpg" },
            { id: 4, name: "Coca-Cola", price: 1.00, stock: 45, minStock: 20, category: "Boisson", image: "image/cocacola.jpg" },
            { id: 5, name: "Coca-Cola Cherry", price: 1.00, stock: 25, minStock: 10, category: "Boisson", image: "image/cocacolacherry.jpg" },
            { id: 6, name: "Oasis Pomme-Cassis", price: 1.00, stock: 35, minStock: 15, category: "Boisson", image: "image/oasispommecasis.jpg" },
            { id: 7, name: "Fanta", price: 1.00, stock: 30, minStock: 15, category: "Boisson", image: "image/orange.jpg" },
            { id: 8, name: "Lipton", price: 1.00, stock: 45, minStock: 20, category: "Boisson", image: "image/lipton.jpg" },
            { id: 9, name: "Sirop", price: 0.50, stock: 25, minStock: 10, category: "Boisson", image: "image/sirop.jpg" },
            { id: 10, name: "Bouteille Sirop", price: 0.30, stock: 35, minStock: 15, category: "Boisson", image: "image/siropbouteille.jpg" },
            { id: 11, name: "Diabolo", price: 1.50, stock: 30, minStock: 15, category: "Boisson", image: "image/diabolo.jpg" },
            { id: 12, name: "Th√©", price: 2.00, stock: 45, minStock: 20, category: "Boisson", image: "image/th√©.jpg" },
            { id: 13, name: "Jus de fruit", price: 2.00, stock: 45, minStock: 20, category: "Boisson", image: "image/jusfruit.jpg" },
            { id: 14, name: "Jus de Pomme", price: 2.00, stock: 45, minStock: 20, category: "Boisson", image: "image/jusdepomme.jpg" },
            { id: 15, name: "Chips BBQ", price: 3.50, stock: 50, minStock: 10, category: "Sal√©", image: "image/chipsbbq.jpg" },
            { id: 16, name: "Chips Nature", price: 1.50, stock: 30, minStock: 15, category: "Sal√©", image: "image/chipsnature.jpg" },
            { id: 17, name: "Chips Poulet", price: 2.00, stock: 45, minStock: 20, category: "Sal√©", image: "image/chipspouletroti.jpg" },
            { id: 18, name: "Saucisson", price: 2.50, stock: 25, minStock: 10, category: "Sal√©", image: "image/saucisson.jpg" },
            { id: 19, name: "Pain au Chocolat", price: 1.50, stock: 35, minStock: 15, category: "Sucr√©", image: "image/painchocolat.jpg" },
            { id: 20, name: "Croissant", price: 1.50, stock: 30, minStock: 15, category: "Sucr√©", image: "image/croissant.jpg" },
            { id: 21, name: "Lion", price: 2.00, stock: 45, minStock: 20, category: "Sucr√©", image: "image/lion.jpg" },
            { id: 22, name: "KitKat", price: 2.50, stock: 25, minStock: 10, category: "Sucr√©", image: "image/kitkat.jpg" },
            { id: 23, name: "Twix", price: 1.50, stock: 35, minStock: 15, category: "Sucr√©", image: "image/twix.jpg" },
            { id: 24, name: "Or√©o", price: 1.50, stock: 30, minStock: 15, category: "Sucr√©", image: "image/or√©o.jpg" },
            { id: 25, name: "Petit √©colier", price: 2.00, stock: 45, minStock: 20, category: "Sucr√©", image: "image/petit√©colier.jpg" },
            { id: 26, name: "M&M's", price: 2.00, stock: 45, minStock: 20, category: "Sucr√©", image: "image/M&Ms.jpg" },
            { id: 27, name: "Bonbon", price: 2.50, stock: 25, minStock: 10, category: "Sucr√©", image: "image/bonbons.jpg" },
            { id: 28, name: "Cr√™pe", price: 1.50, stock: 35, minStock: 15, category: "Sucr√©", image: "image/crepe.jpg" },
            { id: 29, name: "Kinder Bueno", price: 1.50, stock: 30, minStock: 15, category: "Sucr√©", image: "image/kinderbueno.jpg" },
            { id: 30, name: "Compote", price: 2.00, stock: 45, minStock: 20, category: "Sucr√©", image: "image/compote.jpg" }
        ];

        let cart = [];
        let sales = [];
        let editingId = null;

        // Persistent storage
        async function loadData() {
            try {
                const productsData = await window.storage.get('mdl_products');
                const salesData = await window.storage.get('mdl_sales');
                
                if (productsData) products = JSON.parse(productsData.value);
                if (salesData) sales = JSON.parse(salesData.value);
            } catch (error) {
                console.log('Chargement initial des donn√©es par d√©faut');
            }
            
            renderProducts();
            renderCart();
        }

        async function save() {
            try {
                await window.storage.set('mdl_products', JSON.stringify(products));
                await window.storage.set('mdl_sales', JSON.stringify(sales));
            } catch (error) {
                console.error('Erreur de sauvegarde:', error);
            }
        }

        function switchTab(event, tab) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'stock') renderStock();
            if (tab === 'stats') renderStats();
            if (tab === 'courses') renderCourses();
        }

        function renderProducts() {
            const search = document.getElementById('searchProduct').value.toLowerCase();
            const filtered = products.filter(p => p.name && p.name.toLowerCase().includes(search));
            
            document.getElementById('productsList').innerHTML = filtered.length ? filtered.map(p => {
                const imageContent = p.image && p.image.trim() !== '' && p.image !== 'image/' 
                    ? `<img src="${p.image}" alt="${p.name}" onerror="this.parentElement.innerHTML='üì¶'">` 
                    : 'üì¶';
                
                const isOutOfStock = p.stock === 0;
                const isLowStock = p.stock > 0 && p.stock <= p.minStock;
                const cardClass = isOutOfStock ? 'product-card out-of-stock' : isLowStock ? 'product-card low-stock' : 'product-card';
                
                return `
                    <div class="${cardClass}" onclick="${isOutOfStock ? '' : `addToCart(${p.id})`}">
                        <div class="product-image">
                            ${imageContent}
                        </div>
                        <div class="product-name">${p.name}</div>
                        <div class="product-price">${p.price.toFixed(2)} ‚Ç¨</div>
                        <div class="product-stock" style="color: ${isOutOfStock ? '#dc2626' : isLowStock ? '#f59e0b' : '#10b981'}; font-weight: ${isOutOfStock || isLowStock ? '700' : '400'}">
                            ${isOutOfStock ? '‚ùå Rupture' : isLowStock ? '‚ö†Ô∏è Stock faible: ' + p.stock : '‚úì Stock: ' + p.stock}
                        </div>
                    </div>
                `;
            }).join('') : '<div class="empty-state"><div class="empty-emoji">üîç</div><div>Aucun produit trouv√©</div></div>';
        }

        function addToCart(id) {
            const product = products.find(p => p.id === id);
            if (!product || product.stock === 0) {
                showNotification('‚ö†Ô∏è Produit en rupture de stock', 'error');
                return;
            }
            
            const item = cart.find(i => i.id === id);
            if (item) {
                if (item.quantity >= product.stock) {
                    showNotification('‚ö†Ô∏è Stock insuffisant', 'error');
                    return;
                }
                item.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            
            renderCart();
        }

        function renderCart() {
            const div = document.getElementById('cartItems');
            const validateBtn = document.querySelector('.validate-btn');
            
            if (cart.length === 0) {
                div.innerHTML = '<div class="empty-state"><div class="empty-emoji">üõí</div><div>Panier vide</div></div>';
                document.getElementById('cartTotal').textContent = '0.00 ‚Ç¨';
                if (validateBtn) validateBtn.disabled = true;
                return;
            }
            
            if (validateBtn) validateBtn.disabled = false;
            
            div.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price.toFixed(2)} ‚Ç¨ √ó ${item.quantity} = ${(item.price * item.quantity).toFixed(2)} ‚Ç¨</div>
                    </div>
                    <div class="cart-controls">
                        <button class="cart-btn" onclick="updateCart(${item.id}, -1)">‚àí</button>
                        <span class="cart-quantity">${item.quantity}</span>
                        <button class="cart-btn" onclick="updateCart(${item.id}, 1)">+</button>
                        <button class="cart-btn delete" onclick="removeCart(${item.id})">√ó</button>
                    </div>
                </div>
            `).join('');
            
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            document.getElementById('cartTotal').textContent = total.toFixed(2) + ' ‚Ç¨';
        }

        function updateCart(id, delta) {
            const item = cart.find(i => i.id === id);
            const product = products.find(p => p.id === id);
            if (item) {
                item.quantity += delta;
                if (item.quantity > product.stock) {
                    item.quantity = product.stock;
                }
                if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
                renderCart();
            }
        }

        function removeCart(id) {
            cart = cart.filter(i => i.id !== id);
            renderCart();
        }

        function validateSale() {
            if (cart.length === 0) {
                alert('‚ö†Ô∏è Le panier est vide !');
                return;
            }
            
            for (const item of cart) {
                const product = products.find(p => p.id === item.id);
                if (!product || product.stock < item.quantity) {
                    alert(`‚ö†Ô∏è Stock insuffisant pour ${item.name}`);
                    return;
                }
            }
            
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            sales.unshift({
                id: Date.now(),
                date: new Date().toISOString(),
                items: [...cart],
                total
            });
            
            products = products.map(p => {
                const item = cart.find(i => i.id === p.id);
                return item ? { ...p, stock: p.stock - item.quantity } : p;
            });
            
            cart = [];
            save();
            renderCart();
            renderProducts();
            
            showNotification('‚úÖ Vente valid√©e avec succ√®s !', 'success');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function renderStock() {
            document.getElementById('stockTable').innerHTML = products.map(p => {
                const imageContent = p.image && p.image.trim() !== '' && p.image !== 'image/' 
                    ? `<img src="${p.image}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='üì¶'">` 
                    : 'üì¶';
                
                return `
                <tr>
                    <td>
                        ${editingId === p.id ? 
                            `<input type="file" accept="image/*" onchange="uploadImage(${p.id}, event)" style="font-size: 0.75rem;">` :
                            `<div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; background: #f1f5f9; display: flex; align-items: center; justify-content: center;">
                                ${imageContent}
                            </div>`
                        }
                    </td>
                    <td>${editingId === p.id ?
                        `<input value="${p.name}" onchange="updateProd(${p.id}, 'name', this.value)" style="width:100%">` : 
                        `<strong>${p.name || '-'}</strong>`}</td>
                    <td>${editingId === p.id ?
                        `<input value="${p.category}" onchange="updateProd(${p.id}, 'category', this.value)" style="width:100%">` : 
                        `${p.category || '-'}`}</td>
                    <td>${editingId === p.id ?
                        `<input type="number" step="0.01" value="${p.price}" onchange="updateProd(${p.id}, 'price', parseFloat(this.value))" style="width:80px">` :
                        `<strong style="color: #3b82f6">${p.price.toFixed(2)} ‚Ç¨</strong>`}</td>
                    <td>${editingId === p.id ?
                        `<input type="number" value="${p.stock}" onchange="updateProd(${p.id}, 'stock', parseInt(this.value))" style="width:60px">` :
                        `<strong style="color: ${p.stock <= p.minStock ? '#dc2626' : '#10b981'}">${p.stock}</strong>`}</td>
                    <td>${editingId === p.id ?
                        `<input type="number" value="${p.minStock}" onchange="updateProd(${p.id}, 'minStock', parseInt(this.value))" style="width:60px">` :
                        p.minStock}</td>
                    <td>
                        ${editingId === p.id ?
                            `<button class="btn-icon btn-save" onclick="editingId=null; save(); renderStock()">‚úì</button>` :
                            `<button class="btn-icon btn-edit" onclick="editingId=${p.id}; renderStock()">‚úèÔ∏è</button>
                             <button class="btn-icon btn-delete" onclick="deleteProd(${p.id})">üóëÔ∏è</button>`
                        }
                    </td>
                </tr>
                `;
            }).join('');
        }

        function uploadImage(id, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    updateProd(id, 'image', e.target.result);
                    renderStock();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateProd(id, field, value) {
            products = products.map(p => p.id === id ? { ...p, [field]: value } : p);
            save();
        }

        function addProduct() {
            const newP = {
                id: Date.now(),
                name: 'Nouveau Produit',
                price: 0,
                stock: 0,
                category: 'Boisson',
                minStock: 5,
                image: ''
            };
            products.push(newP);
            editingId = newP.id;
            save();
            renderStock();
        }

        function deleteProd(id) {
            if (confirm('Supprimer ce produit ?')) {
                products = products.filter(p => p.id !== id);
                save();
                renderStock();
                showNotification('üóëÔ∏è Produit supprim√©', 'success');
            }
        }

        function renderStats() {
            const period = document.getElementById('statsPeriod')?.value || 'all';
            const now = new Date();
            
            const filtered = sales.filter(s => {
                const saleDate = new Date(s.date);
                if (period === 'today') {
                    return saleDate.toDateString() === now.toDateString();
                } else if (period === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return saleDate >= weekAgo;
                } else if (period === 'month') {
                    return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
                } else if (period === 'year') {
                    return saleDate.getFullYear() === now.getFullYear();
                }
                return true;
            });
            
            const total = filtered.reduce((sum, s) => sum + s.total, 0);
            const count = filtered.length;
            const avg = count > 0 ? total / count : 0;
            const totalItems = filtered.reduce((sum, s) => sum + s.items.reduce((iSum, i) => iSum + i.quantity, 0), 0);
            
            document.getElementById('statRevenue').textContent = total.toFixed(2) + ' ‚Ç¨';
            document.getElementById('statSales').textContent = count;
            document.getElementById('statAvg').textContent = avg.toFixed(2) + ' ‚Ç¨';
            document.getElementById('statTotalItems').textContent = totalItems;
            
            const prevFiltered = sales.filter(s => {
                const saleDate = new Date(s.date);
                if (period === 'today') {
                    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    return saleDate.toDateString() === yesterday.toDateString();
                } else if (period === 'week') {
                    const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return saleDate >= twoWeeksAgo && saleDate < weekAgo;
                } else if (period === 'month') {
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    return saleDate.getMonth() === lastMonth.getMonth() && saleDate.getFullYear() === lastMonth.getFullYear();
                }
                return false;
            });
            
            const prevTotal = prevFiltered.reduce((sum, s) => sum + s.total, 0);
            const prevCount = prevFiltered.length;
            const prevAvg = prevCount > 0 ? prevTotal / prevCount : 0;
            
            const revenueEvol = prevTotal > 0 ? ((total - prevTotal) / prevTotal * 100).toFixed(1) : 0;
            const salesEvol = prevCount > 0 ? ((count - prevCount) / prevCount * 100).toFixed(1) : 0;
            const avgEvol = prevAvg > 0 ? ((avg - prevAvg) / prevAvg * 100).toFixed(1) : 0;
            
            document.getElementById('statRevenueEvolution').innerHTML = revenueEvol > 0 ? `üìà +${revenueEvol}%` : revenueEvol < 0 ? `üìâ ${revenueEvol}%` : '‚û°Ô∏è 0%';
            document.getElementById('statSalesEvolution').innerHTML = salesEvol > 0 ? `üìà +${salesEvol}%` : salesEvol < 0 ? `üìâ ${salesEvol}%` : '‚û°Ô∏è 0%';
            document.getElementById('statAvgEvolution').innerHTML = avgEvol > 0 ? `üìà +${avgEvol}%` : avgEvol < 0 ? `üìâ ${avgEvol}%` : '‚û°Ô∏è 0%';
            
            const productSales = {};
            filtered.forEach(s => {
                s.items.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = { ...item, sold: 0, revenue: 0 };
                    }
                    productSales[item.id].sold += item.quantity;
                    productSales[item.id].revenue += item.quantity * item.price;
                });
            });
            
            const topProds = Object.values(productSales).sort((a, b) => b.revenue - a.revenue).slice(0, 40);
            
            document.getElementById('topProducts').innerHTML = topProds.length ? topProds.map((p, i) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: ${i === 0 ? 'linear-gradient(135deg, #fef3c7, #fde68a)' : '#f8fafc'}; border-radius: 12px; margin-bottom: 0.75rem; ${i === 0 ? 'border: 2px solid #f59e0b;' : ''}">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 35px; height: 35px; background: ${i === 0 ? '#f59e0b' : i === 1 ? '#94a3b8' : i === 2 ? '#cd7f32' : '#3b82f6'}; color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem;">${i === 0 ? 'üëë' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i+1}</div>
                        <div>
                            <div style="font-weight: 600; font-size: 0.9rem;">${p.name}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${p.category} ‚Ä¢ ${p.sold} vendus</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: ${i === 0 ? '#f59e0b' : '#3b82f6'}; font-size: 1rem;">${p.revenue.toFixed(2)} ‚Ç¨</div>
                        <div style="font-size: 0.75rem; color: #64748b;">${p.price.toFixed(2)}‚Ç¨ √ó ${p.sold}</div>
                    </div>
                </div>
            `).join('') : '<div class="empty-state"><div class="empty-emoji">üèÜ</div><div>Aucune donn√©e</div></div>';
            
            document.getElementById('recentSales').innerHTML = filtered.slice(0, 20).map(s => `
                <div style="padding: 1rem; background: #f8fafc; border-radius: 12px; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.8rem; color: #64748b;">${new Date(s.date).toLocaleString('fr-FR', {dateStyle: 'short', timeStyle: 'short'})}</span>
                        <span style="font-weight: 700; color: #10b981; font-size: 0.9rem;">${s.total.toFixed(2)} ‚Ç¨</span>
                    </div>
                    <div style="font-size: 0.85rem; color: #475569;">${s.items.map(i => `${i.quantity}√ó ${i.name}`).join(', ')}</div>
                </div>
            `).join('') || '<div class="empty-state"><div class="empty-emoji">üìä</div><div>Aucune vente</div></div>';
            
            const categoryStats = {};
            filtered.forEach(s => {
                s.items.forEach(item => {
                    const cat = item.category || 'Autre';
                    if (!categoryStats[cat]) {
                        categoryStats[cat] = { revenue: 0, quantity: 0 };
                    }
                    categoryStats[cat].revenue += item.quantity * item.price;
                    categoryStats[cat].quantity += item.quantity;
                });
            });
            
            const categoryArray = Object.entries(categoryStats).sort((a, b) => b[1].revenue - a[1].revenue);
            const totalCatRevenue = categoryArray.reduce((sum, [, data]) => sum + data.revenue, 0);
            
            const categoryColors = {
                'Boisson': '#3b82f6',
                'Sucr√©': '#f59e0b',
                'Sal√©': '#10b981',
                'Autre': '#8b5cf6'
            };
            
            document.getElementById('categoryStats').innerHTML = categoryArray.length ? categoryArray.map(([cat, data]) => {
                const percent = totalCatRevenue > 0 ? (data.revenue / totalCatRevenue * 100).toFixed(1) : 0;
                const color = categoryColors[cat] || '#64748b';
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600;">${cat}</span>
                            <span style="font-weight: 700; color: ${color};">${data.revenue.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="flex: 1; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                <div style="height: 100%; background: ${color}; width: ${percent}%; transition: width 0.5s ease;"></div>
                            </div>
                            <span style="font-size: 0.85rem; color: #64748b; min-width: 50px; text-align: right;">${percent}%</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">${data.quantity} articles vendus</div>
                    </div>
                `;
            }).join('') : '<div class="empty-state"><div class="empty-emoji">üè∑Ô∏è</div><div>Aucune donn√©e</div></div>';
            
            const uniqueDays = [...new Set(filtered.map(s => new Date(s.date).toDateString()))].length;
            const avgDailyRev = uniqueDays > 0 ? total / uniqueDays : 0;
            document.getElementById('avgDailyRevenue').textContent = avgDailyRev.toFixed(2) + ' ‚Ç¨';
            
            const dailyRevenues = {};
            filtered.forEach(s => {
                const day = new Date(s.date).toDateString();
                dailyRevenues[day] = (dailyRevenues[day] || 0) + s.total;
            });
            const bestDayRevenue = Math.max(...Object.values(dailyRevenues), 0);
            document.getElementById('bestDay').textContent = bestDayRevenue.toFixed(2) + ' ‚Ç¨';
            
            const stockValue = products.reduce((sum, p) => sum + (p.stock * p.price), 0);
            document.getElementById('stockValue').textContent = stockValue.toFixed(2) + ' ‚Ç¨';
            
            const topProd = topProds[0];
            document.getElementById('topProduct').textContent = topProd ? `${topProd.name} (${topProd.revenue.toFixed(2)}‚Ç¨)` : '-';
            
            const forecast = avgDailyRev * 7;
            const forecastMonth = avgDailyRev * 30;
            document.getElementById('forecastWeek').textContent = forecast.toFixed(2) + ' ‚Ç¨';
            document.getElementById('forecastMonth').textContent = forecastMonth.toFixed(2) + ' ‚Ç¨';
            
            renderRevenueChart(filtered);
            renderHourlyChart(filtered);
            renderWeekdayChart(filtered);
        }
        
        function renderRevenueChart(salesData) {
            const canvas = document.getElementById('revenueChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const chartDays = parseInt(document.getElementById('chartPeriod')?.value || '14');
            
            const dailyData = {};
            salesData.forEach(s => {
                const day = new Date(s.date).toLocaleDateString('fr-FR');
                dailyData[day] = (dailyData[day] || 0) + s.total;
            });
            
            const sortedDays = Object.keys(dailyData).sort((a, b) => {
                const dateA = a.split('/').reverse().join('-');
                const dateB = b.split('/').reverse().join('-');
                return dateA.localeCompare(dateB);
            }).slice(-chartDays);
            
            const data = sortedDays.map(day => dailyData[day] || 0);
            const maxValue = Math.max(...data, 1);
            
            canvas.height = 300;
            canvas.width = canvas.offsetWidth;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 50;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const barWidth = Math.max(chartWidth / sortedDays.length - 4, 20);
            const spacing = chartWidth / sortedDays.length;
            
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                const value = maxValue * (1 - i / 5);
                ctx.fillStyle = '#64748b';
                ctx.font = '11px Outfit';
                ctx.textAlign = 'right';
                ctx.fillText(value.toFixed(0) + '‚Ç¨', padding - 5, y + 4);
            }
            
            data.forEach((value, index) => {
                const barHeight = (value / maxValue) * chartHeight;
                const x = padding + index * spacing + (spacing - barWidth) / 2;
                const y = canvas.height - padding - barHeight;
                
                const gradient = ctx.createLinearGradient(0, y, 0, canvas.height - padding);
                gradient.addColorStop(0, '#3b82f6');
                gradient.addColorStop(1, '#1e40af');
                
                ctx.shadowColor = 'rgba(59, 130, 246, 0.3)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetY = 4;
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.shadowColor = 'transparent';
                
                if (value > 0) {
                    ctx.fillStyle = '#0f172a';
                    ctx.font = 'bold 11px Outfit';
                    ctx.textAlign = 'center';
                    ctx.fillText(value.toFixed(0) + '‚Ç¨', x + barWidth / 2, y - 8);
                }
            });
            
            ctx.fillStyle = '#64748b';
            ctx.font = '10px Outfit';
            sortedDays.forEach((day, index) => {
                const x = padding + index * spacing + spacing / 2;
                ctx.save();
                ctx.translate(x, canvas.height - 25);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(day.substring(0, 5), 0, 0);
                ctx.restore();
            });
        }
        
        function renderHourlyChart(salesData) {
            const canvas = document.getElementById('hourlyChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            const hourlyData = new Array(24).fill(0);
            const hourlyCounts = new Array(24).fill(0);
            
            salesData.forEach(s => {
                const hour = new Date(s.date).getHours();
                hourlyData[hour] += s.total;
                hourlyCounts[hour]++;
            });
            
            canvas.height = 250;
            canvas.width = canvas.offsetWidth;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const maxValue = Math.max(...hourlyData, 1);
            
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            ctx.beginPath();
            ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
            hourlyData.forEach((value, hour) => {
                const x = padding + (hour / 23) * chartWidth;
                const y = canvas.height - padding - (value / maxValue) * chartHeight;
                if (hour === 0) {
                    ctx.moveTo(x, canvas.height - padding);
                    ctx.lineTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.closePath();
            ctx.fill();
            
            ctx.beginPath();
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            
            hourlyData.forEach((value, hour) => {
                const x = padding + (hour / 23) * chartWidth;
                const y = canvas.height - padding - (value / maxValue) * chartHeight;
                
                if (hour === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            hourlyData.forEach((value, hour) => {
                if (value > 0) {
                    const x = padding + (hour / 23) * chartWidth;
                    const y = canvas.height - padding - (value / maxValue) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.fillStyle = 'white';
                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 3;
                    ctx.arc(x, y, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    if (value > maxValue * 0.7) {
                        ctx.fillStyle = '#0f172a';
                        ctx.font = 'bold 10px Outfit';
                        ctx.textAlign = 'center';
                        ctx.fillText(value.toFixed(0) + '‚Ç¨', x, y - 12);
                    }
                }
            });
            
            ctx.fillStyle = '#64748b';
            ctx.font = '11px Outfit';
            ctx.textAlign = 'center';
            for (let h = 0; h < 24; h += 2) {
                const x = padding + (h / 23) * chartWidth;
                ctx.fillText(h + 'h', x, canvas.height - 10);
            }
            
            ctx.textAlign = 'right';
            ctx.font = '10px Outfit';
            for (let i = 0; i <= 4; i++) {
                const y = padding + (chartHeight / 4) * i;
                const value = maxValue * (1 - i / 4);
                ctx.fillText(value.toFixed(0) + '‚Ç¨', padding - 5, y + 4);
            }
        }
        
        function renderWeekdayChart(salesData) {
            const canvas = document.getElementById('weekdayChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            const weekdays = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const weekdayData = new Array(7).fill(0);
            const weekdayCounts = new Array(7).fill(0);
            
            salesData.forEach(s => {
                const day = new Date(s.date).getDay();
                weekdayData[day] += s.total;
                weekdayCounts[day]++;
            });
            
            const avgData = weekdayData.map((total, i) => weekdayCounts[i] > 0 ? total / weekdayCounts[i] : 0);
            
            canvas.height = 250;
            canvas.width = canvas.offsetWidth;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 50;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const maxValue = Math.max(...avgData, 1);
            const barWidth = Math.min(chartWidth / 7 - 10, 80);
            const spacing = chartWidth / 7;
            
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                const value = maxValue * (1 - i / 4);
                ctx.fillStyle = '#64748b';
                ctx.font = '11px Outfit';
                ctx.textAlign = 'right';
                ctx.fillText(value.toFixed(0) + '‚Ç¨', padding - 5, y + 4);
            }
            
            avgData.forEach((value, index) => {
                const barHeight = (value / maxValue) * chartHeight;
                const x = padding + index * spacing + (spacing - barWidth) / 2;
                const y = canvas.height - padding - barHeight;
                
                let color1, color2;
                if (index === 0 || index === 6) {
                    color1 = '#8b5cf6';
                    color2 = '#6d28d9';
                } else {
                    color1 = '#3b82f6';
                    color2 = '#1e40af';
                }
                
                const gradient = ctx.createLinearGradient(0, y, 0, canvas.height - padding);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                
                ctx.shadowColor = `rgba(59, 130, 246, 0.3)`;
                ctx.shadowBlur = 8;
                ctx.shadowOffsetY = 4;
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.shadowColor = 'transparent';
                
                if (value > 0) {
                    ctx.fillStyle = '#0f172a';
                    ctx.font = 'bold 11px Outfit';
                    ctx.textAlign = 'center';
                    ctx.fillText(value.toFixed(0) + '‚Ç¨', x + barWidth / 2, y - 8);
                }
                
                if (weekdayCounts[index] > 0) {
                    ctx.fillStyle = '#94a3b8';
                    ctx.font = '9px Outfit';
                    ctx.fillText(`(${weekdayCounts[index]} j)`, x + barWidth / 2, y - 20);
                }
            });
            
            ctx.fillStyle = '#475569';
            ctx.font = '11px Outfit';
            ctx.textAlign = 'center';
            weekdays.forEach((day, index) => {
                const x = padding + index * spacing + spacing / 2;
                ctx.fillText(day.substring(0, 3), x, canvas.height - 10);
            });
        }

        function renderCourses() {
            const lowStock = products.filter(p => p.stock <= p.minStock && p.name);
            
            if (lowStock.length === 0) {
                document.getElementById('shoppingList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-emoji">‚úÖ</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;">Stock suffisant</div>
                        <div>Tous les produits sont bien approvisionn√©s</div>
                    </div>
                `;
            } else {
                document.getElementById('shoppingList').innerHTML = lowStock.map(p => {
                    const imageContent = p.image && p.image.trim() !== '' && p.image !== 'image/' 
                        ? `<img src="${p.image}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span style=\\'font-size: 1.5rem;\\'>üì¶</span>'">` 
                        : '<span style="font-size: 1.5rem;">üì¶</span>';
                    
                    return `
                        <div class="alert-box alert-warning" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="width: 50px; height: 50px; border-radius: 10px; overflow: hidden; background: #f1f5f9; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    ${imageContent}
                                </div>
                                <div>
                                    <div style="font-weight: 700; font-size: 1rem;">${p.name}</div>
                                    <div style="font-size: 0.85rem;">${p.category}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: #dc2626; font-size: 0.9rem;">Stock: ${p.stock}</div>
                                <div style="font-size: 0.85rem;">Min: ${p.minStock}</div>
                                <div style="font-weight: 700; color: #1e40af; margin-top: 0.25rem; font-size: 0.9rem;">√Ä commander: ${Math.max(p.minStock * 2 - p.stock, 0)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function exportData() {
            const data = { products, sales, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mdl-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('üíæ Donn√©es export√©es avec succ√®s !', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.products && data.sales) {
                                products = data.products;
                                sales = data.sales;
                                await save();
                                renderProducts();
                                renderCart();
                                showNotification('‚úÖ Donn√©es import√©es avec succ√®s !', 'success');
                            }
                        } catch (error) {
                            showNotification('‚ùå Erreur lors de l\'import du fichier', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert('Impossible de passer en plein √©cran');
                });
            } else {
                document.exitFullscreen();
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>